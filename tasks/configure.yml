---
- name: update server.conf from template
  template:
    src: etc/openvpn/server.conf
    dest: /etc/openvpn/server.conf
    owner: root
    group: root
    mode: 0644
  register: server_conf

- name: create self-signed ca key/certificate pair if required
  shell: >
    make-cadir /etc/openvpn/easy-rsa
    cd /etc/openvpn/easy-rsa
    . vars
    ./pkitool --batch --initca 
    creates={{ openvpn_ca_cert_file }}

- name: create server key/certificate pair if required
  shell: >
    cd /etc/openvpn/easy-rsa
    . vars
    ./pkitool --batch --server server
    creates={{ openvpn_cert_file }}

- name: create dh file if necessary
  command: openssl dhparam -out {{ openvpn_dh_file }} 2048
           creates={{ openvpn_dh_file }}

- name: generate ta.key
  command: openvpn --genkey --secret {{ openvpn_ta_key_file }}
           creates={{ openvpn_ta_key_file }}

- name: restart openvpn
  service:
    name: openvpn
    state: restarted
  when: server_conf|changed
